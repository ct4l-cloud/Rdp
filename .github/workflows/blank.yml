name: Setup Cloudflared Tunnel for RDP

on:
  workflow_dispatch:

jobs:
  rdp-tunnel:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Enable RDP and set password
        run: |
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "UserAuthentication" -Value 1
          $pass = ConvertTo-SecureString "P@ssw0rd!" -AsPlainText -Force
          Set-LocalUser -Name "runneradmin" -Password $pass

      - name: Download cloudflared
        run: |
          Invoke-WebRequest "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" -OutFile "cloudflared.exe"

      - name: Decode and save credentials file
        run: |
          $b64 = "${{ secrets.CLOUDFLARED_TUNNEL_CREDENTIALS }}"
          [IO.File]::WriteAllBytes("cred.json", [Convert]::FromBase64String($b64))

      - name: Create config.yml
        run: |
          Set-Content -Path "config.yml" -Value @"
          tunnel: 163edc35-e96f-4672-ae7e-735a8e21eb8c
          credentials-file: ./cred.json

          ingress:
            - hostname: ${{ secrets.CLOUDFLARED_TUNNEL_DOMAIN }}
              service: rdp://localhost:3389
            - service: http_status:404
          "@

      - name: Start cloudflared tunnel
        run: .\cloudflared.exe tunnel --config config.yml run

      - name: Show Connection Info
        run: |
          echo "‚úÖ Connect to: ${{ secrets.CLOUDFLARED_TUNNEL_DOMAIN }} (Port 3389)"
          echo "üîë Username: runneradmin"
          echo "üîí Password: P@ssw0rd!"

      - name: Keep Alive (6h)
        run: |
          for ($i = 0; $i -lt 72; $i++) {
            Write-Host "‚è≥ Still alive: $($i * 5) minutes"
            Start-Sleep -Seconds 300
          }
