name: Setup Cloudflared Tunnel for RDP

on:
  workflow_dispatch:

jobs:
  rdp-tunnel:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:
      - name: Enable RDP and set password
        run: |
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Set-ItemProperty -Path "HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" -Name "UserAuthentication" -Value 1
          net user admin /add
          net localgroup administrators admin /add
          net user admin admin

      - name: Download cloudflared
        run: |
          Invoke-WebRequest "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" -OutFile "cloudflared.exe"

      - name: Decode and save credentials file
        run: |
          $b64 = "${{ secrets.CLOUDFLARED_TUNNEL_CREDENTIALS }}"
          [IO.File]::WriteAllBytes("cred.json", [Convert]::FromBase64String($b64))

      - name: Create config.yml safely
        run: |
          Set-Content -Path config.yml -Value "tunnel: 163edc35-e96f-4672-ae7e-735a8e21eb8c"
          Add-Content -Path config.yml -Value "credentials-file: ./cred.json"
          Add-Content -Path config.yml -Value ""
          Add-Content -Path config.yml -Value "ingress:"
          Add-Content -Path config.yml -Value "  - hostname: ${{ secrets.CLOUDFLARED_TUNNEL_DOMAIN }}"
          Add-Content -Path config.yml -Value "    service: rdp://localhost:3389"
          Add-Content -Path config.yml -Value "  - service: http_status:404"

      - name: Start cloudflared tunnel
        run: |
          .\cloudflared.exe tunnel --config config.yml run

      - name: Show Connection Info
        run: |
          echo "‚úÖ Connect to: ${{ secrets.CLOUDFLARED_TUNNEL_DOMAIN }} (Port 3389)"
          echo "üîë Username: admin"
          echo "üîí Password: admin"

      - name: Keep Alive (6h)
        run: |
          for ($i = 0; $i -lt 72; $i++) {
            Write-Host "‚è≥ Still alive: $($i * 5) minutes"
            Start-Sleep -Seconds 300
          }
